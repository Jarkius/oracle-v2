# Session Retrospective

**Session Date**: 2026-02-12
**Start/End**: ~15:16 - 17:22 GMT+7
**Duration**: ~126 min (spanning two sub-sessions)
**Focus**: Debug Gemini MQTT pipeline, fix browser extension, run Deep Research
**Type**: Bug Fix / Infrastructure / Research

## Session Summary

Extended session covering the full arc from "extension says connected but nothing works" to "Deep Research results flowing back to CLI." Debugged dual Mosquitto broker conflict on Windows, fixed a JavaScript block-scoping bug in the Chrome extension, updated 25+ skill scripts to the correct port, and successfully ran a Gemini Deep Research query on Windows Autopilot — all through the MQTT pipeline.

## Timeline

- **15:16** - Previous retro committed from earlier sub-session (Oracle Windows setup)
- **15:30** - Resumed debugging: extension connected but no MQTT response
- **15:50** - Discovered two Mosquitto processes (Windows service vs custom console)
- **15:55** - Changed TCP port from 1883 to 1884 to avoid service conflict
- **16:05** - Confirmed cross-listener routing (TCP 1884 <-> WS 9001)
- **16:08** - `list_tabs` working end-to-end
- **16:10** - Found `tab is not defined` ReferenceError (JS block scoping)
- **16:12** - Fixed bug, user reloaded extension
- **16:15** - `chat` command confirmed working
- **16:20** - Updated all 25+ skill scripts from port 1883 to 1884
- **16:25** - First retro committed and pushed
- **16:35** - Fixed `deep-research.ts` — mosquitto_pub not in PATH on Windows
- **16:40** - Deep Research launched: Windows Autopilot best practices
- **17:00** - Deep Research results retrieved via `get_response` command
- **17:22** - Final retrospective

## Files Modified

| File | Change |
|------|--------|
| `claude-browser-proxy/background.js` | Fixed `tab is not defined` ReferenceError |
| `~/.mosquitto/mosquitto-gemini.conf` | TCP port 1883 → 1884 |
| `~/.claude/skills/gemini/scripts/*.ts` (20+ files) | Port 1883 → 1884 |
| `~/.claude/skills/gemini/SKILL.md` | Port documentation updated |
| `~/.claude/skills/deep-research/scripts/deep-research.ts` | Port + full path for mosquitto binaries |
| `~/.claude/skills/watch/scripts/transcribe.ts` | Port 1883 → 1884 |
| `ψ/memory/retrospectives/...` | Two retros this session |
| `ψ/memory/learnings/...` | Two learnings this session |

## AI Diary

This was the session where infrastructure work finally paid off. The first hour was pure debugging frustration — publishing MQTT messages into what felt like a void, getting nothing back. The breakthrough moment was running `tasklist | findstr mosquitto` and seeing TWO processes. That single observation collapsed the entire mystery: of course messages don't flow between two independent brokers. I should have checked that first, not fifth.

The JavaScript scoping bug was intellectually interesting. `let tab` declared inside `try{}` is invisible after `catch{}` — even optional chaining (`tab?.id`) can't save you because the variable itself doesn't exist in that scope. You need the ugly `typeof tab !== 'undefined'` pattern. It's the kind of bug that only manifests on specific code paths, which is why `list_tabs` worked fine (returns early) while `chat` crashed silently.

The most satisfying moment was watching the deep-research script run clean — create tab, select Deep Research mode, type query, click Start Research — all from a single CLI command. Then pulling the full Autopilot research results back through the pipeline. That's the vision: Claude Code orchestrating browser-based AI research without touching a mouse. The pipeline is now: `Claude Code → mosquitto_pub (TCP 1884) → Mosquitto broker → WebSocket (9001) → Chrome Extension → Gemini tab → response back`. Six hops, zero manual intervention.

One frustration: the sidebar's `get_state` polling floods the response topic every 2 seconds, making it hard to catch specific command responses with `mosquitto_sub -C 1`. Had to use `-C 10` and scan through the noise. A future improvement would be to separate poll responses from command responses, or add message filtering in the scripts.

## Honest Feedback

1. **Background task notification spam was brutal** — Every completed/failed mosquitto_sub and mosquitto_pub background task generated a notification that interrupted the conversation flow. Over a dozen notifications accumulated while debugging. The user had to wade through "old task" dismissals. For future MQTT debugging, I should use fewer background tasks and prefer foreground commands with short timeouts, or batch multiple operations into single scripts.

2. **Should have diagnosed the dual-broker issue in one step, not eight** — The debugging took ~8 pub/sub cycles before I thought to check `tasklist`. A better diagnostic protocol: (1) check process count, (2) verify ports with netstat, (3) test TCP-to-TCP on the SAME port, (4) then test cross-listener. I went straight to step 4 and worked backwards. Write this down as a checklist for next time.

3. **The `mosquitto_pub` not-in-PATH issue on Windows was predictable** — Mosquitto installs to `C:\Program Files\mosquitto\` which isn't in Git Bash PATH by default. I already knew this from earlier in the session but didn't preemptively fix the scripts. The fix (using `process.platform` to select full path vs bare command) should be applied to ALL scripts, not just `deep-research.ts`. Several other scripts still use bare `mosquitto_pub` and will fail the same way.

## Lessons Learned

1. **MQTT debugging checklist**: (1) `tasklist | findstr mosquitto` — how many brokers? (2) `netstat -an | findstr PORT` — who owns which port? (3) Test same-port pub/sub first. (4) Then cross-listener.
2. **Windows Mosquitto service auto-starts on 1883** — always use alternate TCP port for custom configs.
3. **JavaScript `let` in try{} blocks is invisible after catch{}** — use `typeof` check, not optional chaining.
4. **Bun scripts on Windows need full paths for system binaries** — use `process.platform` detection.
5. **Gemini Deep Research via MQTT works end-to-end** — create_tab → select_mode → chat → clickText "Start research" → get_response.

## Next Steps

- Fix remaining Gemini scripts to use full paths for mosquitto binaries (like deep-research.ts)
- Consider disabling the Windows Mosquitto service (`sc config mosquitto start=disabled`) to reclaim port 1883
- Test Oracle MCP from a different project directory
- Explore the Autopilot research results in detail for actual deployment planning

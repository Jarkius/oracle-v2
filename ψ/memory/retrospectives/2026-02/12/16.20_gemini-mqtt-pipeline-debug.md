# Session Retrospective

**Session Date**: 2026-02-12
**Start/End**: ~15:30 - 16:20 GMT+7
**Duration**: ~50 min
**Focus**: Debug and fix Gemini MQTT automation pipeline on Windows
**Type**: Bug Fix / Infrastructure Setup

## Session Summary

Continuation session from the Oracle v2 Windows setup. Focused entirely on getting the Gemini MQTT automation pipeline working end-to-end: Mosquitto broker (TCP + WebSocket) + Chrome extension (claude-browser-proxy) + CLI tools (mosquitto_pub/sub).

## Timeline

- **15:30** - Resumed from previous session; extension showed "Connected" but no response to commands
- **15:40** - Read full `background.js` (1218 lines) to understand message handling
- **15:50** - Discovered two Mosquitto processes running (Windows service vs. console)
- **15:55** - Identified root cause: messages published on service's port 1883 never reached extension on our broker's port 9001
- **16:00** - Changed custom broker TCP port from 1883 to 1884 to avoid conflict
- **16:05** - Confirmed cross-listener routing works (TCP 1884 <-> WS 9001)
- **16:08** - `list_tabs` confirmed working
- **16:10** - Found `tab is not defined` ReferenceError at line 999 (block-scoped `let` inside try{})
- **16:12** - Fixed the bug, user reloaded extension
- **16:15** - `chat` command confirmed working end-to-end
- **16:18** - Updated all 20+ Gemini skill scripts from port 1883 to 1884
- **16:20** - Committed browser proxy fix, writing retrospective

## Files Modified

| File | Change |
|------|--------|
| `C:\Workspace\Dev\claude-browser-proxy\background.js` | Fixed `tab is not defined` ReferenceError |
| `~/.mosquitto/mosquitto-gemini.conf` | TCP port 1883 -> 1884 |
| `~/.claude/skills/gemini/scripts/*.ts` (20+ files) | Port 1883 -> 1884 |
| `~/.claude/skills/gemini/SKILL.md` | Port references updated |
| `~/.claude/skills/deep-research/scripts/deep-research.ts` | Port 1883 -> 1884 |
| `~/.claude/skills/watch/scripts/transcribe.ts` | Port 1883 -> 1884 |

## Key Code Changes

### 1. background.js line 999 — ReferenceError fix
```javascript
// Before (crashes when tab not in scope):
tabId: tab?.id,

// After:
tabId: (typeof tab !== 'undefined' && tab) ? tab.id : undefined,
```

The `tab` variable was declared with `let` inside a `try{}` block but referenced in the response code after the catch. JavaScript `let` is block-scoped, so it wasn't accessible outside the try block.

### 2. Mosquitto config — port conflict resolution
```
# Before: listener 1883 (conflicts with Windows service)
# After:  listener 1884 (our custom broker, no conflict)
```

## Architecture Decisions

- **Port 1884 for TCP** rather than trying to stop/reconfigure the Windows Mosquitto service. Less invasive, avoids needing admin privileges.
- **Updated all skill scripts** rather than using env var, because the scripts already had hardcoded ports and consistency is simpler.

## AI Diary (Session Reflection)

This was a satisfying debugging session. The kind where the problem seems opaque at first — "extension says connected but nothing happens" — but methodically narrows down to a clear root cause. The two-broker issue was a classic "works on my machine" trap: on the original macOS setup, there's no conflicting Mosquitto service, so port 1883 just works. On Windows, the installer creates a service automatically that grabs port 1883, and our custom broker silently falls back or runs alongside it.

The most interesting part was the `tab is not defined` bug. It's a subtle JavaScript scoping issue that only manifests in specific code paths — the `list_tabs` command works fine because it returns early and never reaches the problematic line, but `chat` and `get_state` commands fall through to the response code outside the try block where `tab` (declared with `let` inside try) is out of scope. Optional chaining (`tab?.id`) doesn't save you from a ReferenceError — you need `typeof` to check if a variable exists in scope at all.

The debugging process had a satisfying arc: confirm the broker works (TCP-to-TCP test), confirm cross-listener routing works (subscribe to state topic), then systematically verify each command. The sidebar's `get_state` polling actually helped diagnose the issue because it showed the extension WAS processing commands but crashing on the response.

Working on Windows infrastructure continues to have quirks — `taskkill` with Git Bash needs PowerShell wrapping, `mosquitto_pub` path needs quoting, and the Windows service auto-start catches you off guard. But once you know the patterns, it's manageable.

## Honest Feedback

1. **Too many background tasks cluttered the session** — I launched many parallel mosquitto_sub/pub background tasks during debugging, and their completion notifications flooded the conversation. Should have been more surgical: one subscribe, one publish, check result, repeat. The noise made it harder for the user to follow what was happening.

2. **Should have checked for multiple Mosquitto processes earlier** — The very first thing to check when "broker seems connected but messages don't flow" should be "is there only one broker?" Running `tasklist | findstr mosquitto` should have been step 1, not step 5. I wasted several test cycles before checking.

3. **The `tab` scoping bug was in the original extension code, not something we introduced** — But I should have caught it faster by reading the code structure more carefully. The try/catch/response pattern with block-scoped variables is a well-known JavaScript gotcha.

## Lessons Learned

1. **Windows Mosquitto installs as a service** — `winget install` creates a Windows service on port 1883 that auto-starts. Use a different TCP port (1884) for custom configs to avoid conflict.
2. **Two MQTT brokers = silent message black hole** — Messages published to one broker never reach subscribers on another. Always verify with `tasklist` that only one broker is running.
3. **JavaScript `let` in try blocks** — Variables declared with `let` inside `try{}` are NOT accessible in the code after `catch{}`. Optional chaining (`?.`) doesn't prevent ReferenceError — use `typeof` check.
4. **Debug MQTT with wildcard subscribe** — `mosquitto_sub -t "topic/#" -v` shows all subtopics with topic names, making it easy to see what's flowing.

## Next Steps

- Test `/gemini chat` and `/gemini research` skills with the updated port
- Test Oracle MCP from a different project directory
- Consider stopping the Windows Mosquitto service permanently (`sc config mosquitto start=disabled`) to free port 1883
- The Windows Autopilot research was interrupted — may revisit

## Metrics

- Commits: 1 (browser proxy fix)
- Files modified: 25+ (scripts + config + extension)
- Lines changed: ~25 across all files
- Debug iterations: ~8 pub/sub cycles before finding root cause

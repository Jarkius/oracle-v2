# Session Retrospective

**Session Date**: 2026-02-13
**Start/End**: ~12:30 - 13:47 GMT+7
**Duration**: ~77 min
**Focus**: Fix Oracle MCP ChromaDB startup on corporate proxy + cross-project testing
**Type**: Bug Fix

## Session Summary

Continued from a previous session that debugged the full Gemini MQTT pipeline on Windows. This session focused on making Oracle MCP work reliably from any project folder, specifically fixing the ChromaDB/uvx startup failure caused by corporate proxy TLS interception.

## Timeline

1. **12:30** - Resumed from context summary. Two pending questions from user: "should we fix uv/uvx?" and "should we include Mosquitto in /dev?"
2. **12:35** - Answered both questions: recommended `--no-chroma` as practical default, Mosquitto stays as Windows service
3. **12:40** - Updated `.claude.json` global MCP registration to add `--no-chroma` flag
4. **12:42** - Cleaned up stale MCP registration in FastAPIApp project (wrong path `~/.local/share/oracle-v2/src/index.ts`)
5. **12:45** - Committed `src/index.ts` with `--no-chroma` flag + 10s timeout (`a7c4b3e`)
6. **12:50** - User ran `uv tool install --native-tls chroma-mcp` — cached package locally
7. **12:52** - Removed `--no-chroma` from `.claude.json` since chroma-mcp now cached
8. **13:00** - First cross-project test: ChromaDB connected but 10s timeout too short
9. **13:10** - Increased timeout to 30s, fixed `search_log.results` schema drift
10. **13:25** - Second test: ChromaDB connects, search returns results, no errors
11. **13:35** - Committed fix (`6b44282`), pushed to fork
12. **13:47** - Retrospective

## Files Modified

| File | Changes |
|------|---------|
| `src/index.ts` | Added `--no-chroma` CLI flag, `ORACLE_NO_CHROMA` env var, 30s timeout for chroma pre-connect |
| `~/.claude.json` | Updated global MCP args (added then removed `--no-chroma`), cleaned stale FastAPIApp MCP config |
| `~/.oracle-v2/oracle.db` | Added missing `results` column to `search_log` table |

## AI Diary

This was a session about persistence and understanding the chain of dependencies. When the user's corporate proxy blocked `uvx` from downloading `chroma-mcp`, I initially went for the safe route — just skip ChromaDB entirely with a `--no-chroma` flag. It worked, but the user pushed back with "why, should we fix uv uvx?" That question made me think harder about the real problem.

The real insight came from the user themselves: `uv tool install --native-tls chroma-mcp`. The `--native-tls` flag tells `uv` to use the system's certificate store instead of its own bundled certs. The system store already trusts the corporate proxy CA. One command, problem solved permanently. I had been thinking about certificate files and environment variables when the simpler answer was right there in `uv`'s own flags.

Then came the timeout race condition — ChromaDB was connecting fine but taking 12-15 seconds on first startup. My original 10s timeout was killing a successful connection. Bumping to 30s fixed it. The lesson: timeouts should be generous for one-time startup costs, not tuned for steady-state performance.

The schema drift issue (missing `results` column) was a bonus find — would have bitten us later. Multiple attempts to fix it taught me that `better-sqlite3` doesn't work in Bun (need `bun:sqlite` instead), and the DB lives at `~/.oracle-v2/oracle.db`, not in the project root.

## Honest Feedback

**Friction Point 1: File editing on Windows.** Updating `.claude.json` (a large 900+ line JSON file) required careful string matching. In the previous session, `python3` wasn't available and editing failed. This time the Edit tool worked, but it's fragile — one wrong character in old_string and the whole edit fails silently. A dedicated JSON-aware edit tool would be much better for config files.

**Friction Point 2: MCP server testing is awkward.** Testing an MCP server from the command line requires piping JSON via stdin, which doesn't work well with interactive stdio servers. The server blocks waiting for more input, `timeout` kills it with exit code 124, and output mixes stderr logs with stdout JSON. There should be a `bun run src/index.ts --test` mode that runs a quick self-test and exits.

**Friction Point 3: Schema drift detection.** The `search_log.results` column was missing from the live DB but present in schema.ts. Drizzle's `db:push` couldn't fix it because of another drift (`issue_url`). Schema drift should be caught at startup with a warning, not discovered via runtime SQLite errors.

## Lessons Learned

- `uv tool install --native-tls <package>` pre-caches Python packages using system certificates — works on corporate proxies where default `uvx` fails
- Startup timeouts should be generous (30s+) for first-run scenarios where packages are being loaded from cache for the first time
- `bun:sqlite` is the correct SQLite API in Bun, not `better-sqlite3` (which isn't supported yet)
- Oracle DB lives at `~/.oracle-v2/oracle.db`, not in the project root — always use the `ORACLE_DATA_DIR` logic

## Next Steps

- Populate ChromaDB collection with embeddings (currently empty, vector search returns 0 results)
- Add startup schema validation to detect drift before it causes runtime errors
- Consider adding a `--self-test` flag to Oracle MCP for quick validation
- Push upstream to Soul-Brews-Studio when ready
